{% extends "rutas/base.html" %}
{% load humanize %}
{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
/* CSS COMPLETO - Copiado del dashboard actual */
:root {
  --primary: #4f46e5;
  --primary-dark: #4338ca;
  --secondary: #10b981;
  --accent: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --bg-page: #f8fafc;
  --card-bg: #ffffff;
  --border: #e2e8f0;
  --text-dark: #1e293b;
  --text-muted: #64748b;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

.dashboard-container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 24px 16px;
}

.dashboard-header {
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.dashboard-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.dashboard-title h1 {
  font-size: 32px;
  font-weight: 800;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 0;
}

.dashboard-title .icon {
  font-size: 36px;
}

.dashboard-period {
  background: rgba(79, 70, 229, 0.1);
  padding: 10px 20px;
  border-radius: 12px;
  border: 2px solid rgba(79, 70, 229, 0.2);
}

.dashboard-period strong {
  color: var(--primary);
  font-weight: 700;
}

.period-text {
  color: var(--text-dark);
  font-size: 14px;
  font-weight: 600;
}

.filters-card {
  background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  margin-bottom: 24px;
}

.filters-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.filters-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0;
  flex: 1;
}

.filters-icon {
  font-size: 24px;
}

.filters-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  align-items: end;
}

.quick-filters {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.quick-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-muted);
  margin-right: 8px;
}

.quick-btn {
  padding: 8px 16px;
  background: rgba(79, 70, 229, 0.08);
  color: var(--primary);
  border: 2px solid rgba(79, 70, 229, 0.2);
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s ease;
}

.quick-btn:hover {
  background: rgba(79, 70, 229, 0.15);
  border-color: var(--primary);
  transform: translateY(-2px);
}

.quick-btn-reset {
  padding: 8px 16px;
  background: rgba(239, 68, 68, 0.08);
  color: var(--danger);
  border: 2px solid rgba(239, 68, 68, 0.2);
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s ease;
  margin-left: auto;
}

.quick-btn-reset:hover {
  background: rgba(239, 68, 68, 0.15);
  border-color: var(--danger);
  transform: translateY(-2px);
}

.kpis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.kpi-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.kpi-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  transition: height 0.3s ease;
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.kpi-card:hover::before {
  height: 6px;
}

.kpi-card:nth-child(1)::before { background: var(--gradient-2); }
.kpi-card:nth-child(2)::before { background: var(--gradient-3); }
.kpi-card:nth-child(3)::before { background: var(--gradient-4); }
.kpi-card:nth-child(4)::before { background: var(--gradient-1); }

.kpi-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.kpi-label {
  font-size: 14px;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.kpi-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.kpi-card:nth-child(1) .kpi-icon {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
}

.kpi-card:nth-child(2) .kpi-icon {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
}

.kpi-card:nth-child(3) .kpi-icon {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
}

.kpi-card:nth-child(4) .kpi-icon {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
}

.kpi-value {
  font-size: 36px;
  font-weight: 800;
  line-height: 1.2;
  margin-bottom: 8px;
}

.kpi-card:nth-child(1) .kpi-value { color: #f59e0b; }
.kpi-card:nth-child(2) .kpi-value { color: #3b82f6; }
.kpi-card:nth-child(3) .kpi-value { color: #10b981; }
.kpi-card:nth-child(4) .kpi-value { color: #8b5cf6; }

.kpi-subtitle {
  font-size: 13px;
  color: var(--text-muted);
}

.daily-charts-section {
  background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  margin-bottom: 32px;
}

.daily-charts-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
  flex-wrap: wrap;
  gap: 16px;
}

.daily-charts-title {
  display: flex;
  align-items: center;
  gap: 10px;
}

.daily-charts-title h3 {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0;
}

.daily-charts-stats {
  display: flex;
  gap: 20px;
  padding: 12px 16px;
  background: rgba(79, 70, 229, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(79, 70, 229, 0.1);
}

.daily-stat-item {
  text-align: center;
}

.daily-stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.daily-stat-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
}

.daily-charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 20px;
}

.daily-chart-container {
  background: white;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.daily-chart-container h4 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-dark);
  margin: 0 0 15px 0;
  text-align: center;
}

.daily-chart-wrapper {
  position: relative;
  height: 280px;
}

.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.chart-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.chart-card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.chart-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.chart-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0;
  flex: 1;
}

.chart-icon {
  font-size: 24px;
}

.chart-body {
  position: relative;
  height: 300px;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 32px 0 16px 0;
}

.section-header h2 {
  font-size: 24px;
  font-weight: 700;
  color: #000000;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-icon {
  font-size: 28px;
}

.table-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  overflow: hidden;
}

.table-wrapper {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

.data-table thead {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.data-table th {
  padding: 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
}

.data-table td {
  padding: 16px;
  font-size: 14px;
  color: var(--text-dark);
  border-bottom: 1px solid var(--border);
}

.data-table tbody tr {
  transition: background-color 0.2s ease;
}

.data-table tbody tr:hover {
  background: rgba(79, 70, 229, 0.03);
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-muted);
}

.empty-state::before {
  content: "üìä";
  display: block;
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

@media (max-width: 1200px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .daily-charts-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .dashboard-title h1 {
    font-size: 24px;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }
  
  .quick-filters {
    flex-direction: column;
    align-items: stretch;
  }
  
  .quick-btn,
  .quick-btn-reset {
    text-align: center;
  }
  
  .quick-btn-reset {
    margin-left: 0;
  }
  
  .kpis-grid {
    grid-template-columns: 1fr;
  }
  
  .kpi-value {
    font-size: 28px;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-body {
    height: 250px;
  }
  
  .daily-charts-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .daily-charts-stats {
    width: 100%;
    justify-content: space-around;
  }
  
  .daily-charts-grid {
    grid-template-columns: 1fr;
  }
  
  .daily-chart-wrapper {
    height: 250px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

  <div class="dashboard-header">
    <div class="dashboard-title">
      <span class="icon">üìä</span>
      <h1>Dashboard Ejecutivo</h1>
    </div>
    <div class="dashboard-period">
      <span class="period-text">Per√≠odo: <strong>{{ desde }}</strong> ‚Üí <strong>{{ hoy }}</strong></span>
    </div>
  </div>

  <div class="filters-card">
    <div class="filters-header">
      <span class="filters-icon">üîç</span>
      <h3>Filtrar per√≠odo de an√°lisis</h3>
    </div>
    
    <form method="get" class="filters-form">
      <div class="filters-grid">
        <div class="form-group">
          <label class="form-label">Fecha inicio</label>
          <input type="date" name="desde" value="{{ desde }}" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Fecha fin</label>
          <input type="date" name="hasta" value="{{ hoy }}" class="form-input" required>
        </div>
        
        <div class="form-group">
          <button type="submit" class="btn btn-primary">üìä Aplicar filtro</button>
        </div>
      </div>

      <div class="quick-filters">
        <span class="quick-label">Per√≠odos r√°pidos:</span>
        <a href="?dias=7" class="quick-btn">7 d√≠as</a>
        <a href="?dias=30" class="quick-btn">30 d√≠as</a>
        <a href="?dias=60" class="quick-btn">60 d√≠as</a>
        <a href="?dias=90" class="quick-btn">90 d√≠as</a>
        <a href="?dias=180" class="quick-btn">6 meses</a>
        <a href="?dias=365" class="quick-btn">1 a√±o</a>
        <a href="?" class="quick-btn-reset">üîÑ Todo</a>
      </div>
    </form>
  </div>

  <div class="kpis-grid">
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Ingresos Totales</div>
        <div class="kpi-icon">üí∞</div>
      </div>
      <div class="kpi-value">$ {{ kpi_ingresos|floatformat:0|intcomma }}</div>
      <div class="kpi-subtitle">Revenue generado en el per√≠odo</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Kilogramos</div>
        <div class="kpi-icon">‚öñÔ∏è</div>
      </div>
      <div class="kpi-value">{{ kpi_kilos|floatformat:0|intcomma }}</div>
      <div class="kpi-subtitle">kg vendidos en total</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Ventas</div>
        <div class="kpi-icon">üõí</div>
      </div>
      <div class="kpi-value">{{ kpi_n_ventas|intcomma }}</div>
      <div class="kpi-subtitle">Transacciones realizadas</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-label">Ticket Promedio</div>
        <div class="kpi-icon">üéØ</div>
      </div>
      <div class="kpi-value">$ {{ kpi_ticket|floatformat:0|intcomma }}</div>
      <div class="kpi-subtitle">Valor promedio por venta</div>
    </div>
  </div>

  <!-- ‚úÖ GR√ÅFICAS DIARIAS CON SELECTOR DE MES (ACTUAL - NO SE MODIFICA) -->
  <div class="daily-charts-section">
    <div class="daily-charts-header">
      <div class="daily-charts-title">
        <span style="font-size: 24px;">üìÖ</span>
        <h3>Ventas Diarias - {{ mes_actual|capfirst }}</h3>
      </div>
      
      <!-- ‚úÖ SELECTOR DE MES -->
      <form method="get" style="display: flex; align-items: center; gap: 10px;">
        {% if request.GET.desde %}
          <input type="hidden" name="desde" value="{{ request.GET.desde }}">
        {% endif %}
        {% if request.GET.hasta %}
          <input type="hidden" name="hasta" value="{{ request.GET.hasta }}">
        {% endif %}
        {% if request.GET.dias %}
          <input type="hidden" name="dias" value="{{ request.GET.dias }}">
        {% endif %}
        
        <select name="mes_diario" style="padding: 8px 12px; border: 2px solid rgba(79, 70, 229, 0.2); border-radius: 8px; background: white; font-size: 14px; font-weight: 600; color: var(--text-dark); cursor: pointer;">
          {% for mes in meses_disponibles %}
            <option value="{{ mes.valor }}" {% if mes.valor == mes_seleccionado %}selected{% endif %}>
              {{ mes.texto }}
            </option>
          {% endfor %}
        </select>
        
        <button type="submit" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          üìä Ver mes
        </button>
      </form>
      
      <div class="daily-charts-stats">
        <div class="daily-stat-item">
          <div class="daily-stat-label">Total Ventas</div>
          <div class="daily-stat-value">{{ total_cantidad_mes }}</div>
        </div>
        <div class="daily-stat-item">
          <div class="daily-stat-label">Total Facturado</div>
          <div class="daily-stat-value">${{ total_valor_mes|floatformat:0 }}</div>
        </div>
      </div>
    </div>
    
    <div class="daily-charts-grid">
      <div class="daily-chart-container">
        <h4>üõí Cantidad de Ventas por D√≠a</h4>
        <div class="daily-chart-wrapper">
          <canvas id="chartCantidadDiaria"></canvas>
        </div>
      </div>
      
      <div class="daily-chart-container">
        <h4>üí∞ Valor de Ventas por D√≠a ($)</h4>
        <div class="daily-chart-wrapper">
          <canvas id="chartValorDiario"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ NUEVO BLOQUE: PRIMERAS COMPRAS (CLIENTES NUEVOS) -->
  <div class="daily-charts-section">
    <div class="daily-charts-header">
      <div class="daily-charts-title">
        <span style="font-size: 24px;">üÜï</span>
        <h3>Primeras compras (clientes nuevos) - {{ mes_actual|capfirst }}</h3>
      </div>

      <div class="daily-charts-stats">
        <div class="daily-stat-item">
          <div class="daily-stat-label">Clientes nuevos</div>
          <div class="daily-stat-value">{{ total_first_cantidad_mes }}</div>
        </div>
        <div class="daily-stat-item">
          <div class="daily-stat-label">Facturado</div>
          <div class="daily-stat-value">${{ total_first_valor_mes|floatformat:0 }}</div>
        </div>
      </div>
    </div>

    <div class="daily-charts-grid">
      <div class="daily-chart-container">
        <h4>üÜï Clientes nuevos por D√≠a</h4>
        <div class="daily-chart-wrapper">
          <canvas id="chartFirstCantidadDiaria"></canvas>
        </div>
      </div>

      <div class="daily-chart-container">
        <h4>üí∞ Ventas de clientes nuevos por D√≠a ($)</h4>
        <div class="daily-chart-wrapper">
          <canvas id="chartFirstValorDiario"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-header">
        <span class="chart-icon">üìà</span>
        <h3>Evoluci√≥n de Ingresos Mensuales</h3>
      </div>
      <div class="chart-body">
        <canvas id="chartIngresosMes"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <span class="chart-icon">üìä</span>
        <h3>Kilogramos Vendidos por Mes</h3>
      </div>
      <div class="chart-body">
        <canvas id="chartKilosMes"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <span class="chart-icon">üé®</span>
        <h3>Distribuci√≥n por Canal de Venta</h3>
      </div>
      <div class="chart-body">
        <canvas id="chartCanal"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <span class="chart-icon">üèÜ</span>
        <h3>Top Productos por Volumen (kg)</h3>
      </div>
      <div class="chart-body">
        <canvas id="chartTopProductos"></canvas>
      </div>
    </div>
  </div>

  <div class="section-header">
    <span class="section-icon">üìã</span>
    <h2>Detalle Mensual</h2>
  </div>

  <div class="table-card">
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Mes</th>
            <th>Ventas</th>
            <th>Kilogramos</th>
            <th>Ingresos</th>
          </tr>
        </thead>
        <tbody>
          {% for r in serie %}
          <tr>
            <td><strong>{{ r.mes|date:"m-Y" }}</strong></td>
            <td>{{ r.ventas|intcomma }}</td>
            <td>{{ r.kilos|default:0|floatformat:0|intcomma }} kg</td>
            <td>$ {{ r.ingresos|default:0|floatformat:0|intcomma }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4">
              <div class="empty-state">
                <strong>Sin datos disponibles</strong>
                <p>No hay informaci√≥n para mostrar en este per√≠odo</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const labelsMes   = {{ labels_mes_json|safe }};
  const ingresosMes = {{ ingresos_mes_json|safe }};
  const kilosMes    = {{ kilos_mes_json|safe }};

  const canalLabels   = {{ canal_labels_json|safe }};
  const canalIngresos = {{ canal_ingresos_json|safe }};

  const prodLabels = {{ prod_labels_json|safe }};
  const prodKilos  = {{ prod_kilos_json|safe }};
  
  const diasLabels = {{ dias_labels_json|safe }};
  const cantidadPorDia = {{ cantidad_por_dia_json|safe }};
  const valorPorDia = {{ valor_por_dia_json|safe }};

  // ‚úÖ NUEVO: series ‚Äúprimeras compras‚Äù
  const cantidadFirstPorDia = {{ cantidad_first_por_dia_json|safe }};
  const valorFirstPorDia = {{ valor_first_por_dia_json|safe }};

  const gradientColors = {
    primary: ['rgba(79, 70, 229, 0.8)', 'rgba(79, 70, 229, 0.2)'],
    secondary: ['rgba(16, 185, 129, 0.8)', 'rgba(16, 185, 129, 0.2)'],
    multi: [
      'rgba(79, 70, 229, 0.8)',
      'rgba(16, 185, 129, 0.8)',
      'rgba(245, 158, 11, 0.8)',
      'rgba(239, 68, 68, 0.8)',
      'rgba(139, 92, 246, 0.8)',
      'rgba(59, 130, 246, 0.8)'
    ]
  };

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        labels: {
          font: { size: 12, weight: '600' },
          padding: 15
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.8)',
        padding: 12,
        titleFont: { size: 14, weight: 'bold' },
        bodyFont: { size: 13 },
        cornerRadius: 8
      }
    }
  };

  // =========================
  // ACTUAL: Cantidad diaria
  // =========================
  const ctxCantidadDiaria = document.getElementById('chartCantidadDiaria').getContext('2d');
  const gradientCantidadDiaria = ctxCantidadDiaria.createLinearGradient(0, 0, 0, 280);
  gradientCantidadDiaria.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
  gradientCantidadDiaria.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

  new Chart(ctxCantidadDiaria, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Cantidad de Ventas',
        data: cantidadPorDia,
        borderColor: 'rgb(16, 185, 129)',
        backgroundColor: gradientCantidadDiaria,
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: 'rgb(16, 185, 129)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      ...commonOptions,
      plugins: { ...commonOptions.plugins, legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { stepSize: 1, callback: (v) => Math.round(v), font: { size: 11 } }
        },
        x: {
          grid: { display: false },
          ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 45 }
        }
      }
    }
  });

  // =========================
  // ACTUAL: Valor diario
  // =========================
  const ctxValorDiario = document.getElementById('chartValorDiario').getContext('2d');
  const gradientValorDiario = ctxValorDiario.createLinearGradient(0, 0, 0, 280);
  gradientValorDiario.addColorStop(0, 'rgba(79, 70, 229, 0.8)');
  gradientValorDiario.addColorStop(1, 'rgba(79, 70, 229, 0.3)');

  new Chart(ctxValorDiario, {
    type: 'bar',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Valor Total ($)',
        data: valorPorDia,
        backgroundColor: gradientValorDiario,
        borderColor: 'rgb(79, 70, 229)',
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      ...commonOptions,
      plugins: { ...commonOptions.plugins, legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { callback: (v) => '$' + Math.round(v).toLocaleString('es-CL'), font: { size: 11 } }
        },
        x: {
          grid: { display: false },
          ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 45 }
        }
      }
    }
  });

  // =========================
  // ‚úÖ NUEVO: Clientes nuevos por d√≠a
  // =========================
  const ctxFirstCantidad = document.getElementById('chartFirstCantidadDiaria').getContext('2d');
  const gradientFirstCantidad = ctxFirstCantidad.createLinearGradient(0, 0, 0, 280);
  gradientFirstCantidad.addColorStop(0, 'rgba(245, 158, 11, 0.25)');
  gradientFirstCantidad.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

  new Chart(ctxFirstCantidad, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Clientes nuevos',
        data: cantidadFirstPorDia,
        borderColor: 'rgb(245, 158, 11)',
        backgroundColor: gradientFirstCantidad,
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: 'rgb(245, 158, 11)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      ...commonOptions,
      plugins: { ...commonOptions.plugins, legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { stepSize: 1, callback: (v) => Math.round(v), font: { size: 11 } }
        },
        x: {
          grid: { display: false },
          ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 45 }
        }
      }
    }
  });

  // =========================
  // ‚úÖ NUEVO: Facturado clientes nuevos por d√≠a
  // =========================
  const ctxFirstValor = document.getElementById('chartFirstValorDiario').getContext('2d');
  const gradientFirstValor = ctxFirstValor.createLinearGradient(0, 0, 0, 280);
  gradientFirstValor.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
  gradientFirstValor.addColorStop(1, 'rgba(16, 185, 129, 0.25)');

  new Chart(ctxFirstValor, {
    type: 'bar',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Facturado clientes nuevos ($)',
        data: valorFirstPorDia,
        backgroundColor: gradientFirstValor,
        borderColor: 'rgb(16, 185, 129)',
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      ...commonOptions,
      plugins: { ...commonOptions.plugins, legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { callback: (v) => '$' + Math.round(v).toLocaleString('es-CL'), font: { size: 11 } }
        },
        x: {
          grid: { display: false },
          ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 45 }
        }
      }
    }
  });

  // =========================
  // Mensual: Ingresos
  // =========================
  const ctxIngresos = document.getElementById("chartIngresosMes").getContext('2d');
  const gradientIngresos = ctxIngresos.createLinearGradient(0, 0, 0, 300);
  gradientIngresos.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
  gradientIngresos.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

  new Chart(ctxIngresos, {
    type: "line",
    data: {
      labels: labelsMes,
      datasets: [{
        label: "Ingresos ($)",
        data: ingresosMes,
        borderColor: 'rgb(245, 158, 11)',
        backgroundColor: gradientIngresos,
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointRadius: 5,
        pointHoverRadius: 7,
        pointBackgroundColor: 'rgb(245, 158, 11)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      ...commonOptions,
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { callback: (v) => "$ " + Math.round(v).toLocaleString("es-CL"), font: { size: 11 } }
        },
        x: { grid: { display: false }, ticks: { font: { size: 11 } } }
      }
    }
  });

  // =========================
  // Mensual: Kilos
  // =========================
  const ctxKilos = document.getElementById("chartKilosMes").getContext('2d');
  const gradientKilos = ctxKilos.createLinearGradient(0, 0, 0, 300);
  gradientKilos.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
  gradientKilos.addColorStop(1, 'rgba(59, 130, 246, 0.3)');

  new Chart(ctxKilos, {
    type: "bar",
    data: {
      labels: labelsMes,
      datasets: [{
        label: "Kilogramos",
        data: kilosMes,
        backgroundColor: gradientKilos,
        borderColor: 'rgb(59, 130, 246)',
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      ...commonOptions,
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { callback: (v) => Math.round(v).toLocaleString("es-CL") + " kg", font: { size: 11 } }
        },
        x: { grid: { display: false }, ticks: { font: { size: 11 } } }
      }
    }
  });

  // =========================
  // Canal: Doughnut
  // =========================
  new Chart(document.getElementById("chartCanal"), {
    type: "doughnut",
    data: {
      labels: canalLabels,
      datasets: [{
        label: "Ingresos",
        data: canalIngresos,
        backgroundColor: gradientColors.multi,
        borderWidth: 3,
        borderColor: '#fff',
        hoverOffset: 15
      }]
    },
    options: {
      ...commonOptions,
      cutout: '65%',
      plugins: {
        legend: { 
          position: "bottom",
          labels: {
            font: { size: 12, weight: '600' },
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.label}: $ ${Math.round(ctx.raw).toLocaleString("es-CL")}`
          }
        }
      }
    }
  });

  // =========================
  // Top productos
  // =========================
  const ctxProductos = document.getElementById("chartTopProductos").getContext('2d');
  const gradientProductos = ctxProductos.createLinearGradient(0, 0, 400, 0);
  gradientProductos.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
  gradientProductos.addColorStop(1, 'rgba(16, 185, 129, 0.3)');

  new Chart(ctxProductos, {
    type: "bar",
    data: {
      labels: prodLabels,
      datasets: [{
        label: "Kilogramos",
        data: prodKilos,
        backgroundColor: gradientProductos,
        borderColor: 'rgb(16, 185, 129)',
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      ...commonOptions,
      indexAxis: "y",
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { callback: (v) => Math.round(v).toLocaleString("es-CL") + " kg", font: { size: 11 } }
        },
        y: {
          grid: { display: false },
          ticks: { font: { size: 11 }, autoSkip: false }
        }
      }
    }
  });
</script>
{% endblock %}
